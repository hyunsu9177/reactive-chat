<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reactive Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .chat-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .chat-header {
      background: #007bff;
      color: white;
      padding: 20px;
      border-radius: 10px 10px 0 0;
      text-align: center;
    }
    .online-users {
      background: #e9ecef;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }
    .chat-messages {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      border-bottom: 1px solid #ddd;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
      max-width: 70%;
    }
    .message.own {
      background: #007bff;
      color: white;
      margin-left: auto;
    }
    .message.other {
      background: #f8f9fa;
      border: 1px solid #ddd;
      margin-right: auto;
    }
    .message.system {
      background: #28a745;
      color: white;
      text-align: center;
      font-style: italic;
      margin: 0 auto;
      max-width: 90%;
    }
    .message-sender {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
    }
    .message-content {
      word-wrap: break-word;
    }
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 5px;
    }
    .chat-input {
      display: flex;
      padding: 20px;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
      font-size: 14px;
    }
    .chat-input button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .chat-input button:hover {
      background: #0056b3;
    }
    .chat-input button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .connection-status {
      padding: 8px 20px;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
    }
    .connected {
      background: #d4edda;
      color: #155724;
    }
    .disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    .connecting {
      background: #fff3cd;
      color: #856404;
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    <h2>ğŸš€ Reactive Chat</h2>
    <div id="connection-status" class="connection-status disconnected">
      ì—°ê²° ì•ˆë¨
    </div>
  </div>

  <div class="online-users">
    <strong>ğŸ’š ì˜¨ë¼ì¸ ì‚¬ìš©ì (<span id="online-count">0</span>ëª…):</strong>
    <span id="online-users-list">ì—†ìŒ</span>
  </div>

  <div id="chat-messages" class="chat-messages">
    <div class="message system">
      ì±„íŒ…ì— ì°¸ì—¬í•˜ë ¤ë©´ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ê³  ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
    </div>
  </div>

  <div class="chat-input">
    <input type="text" id="username-input" placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
    <button id="connect-btn" onclick="connect()">ì—°ê²°</button>
    <button id="disconnect-btn" onclick="disconnect()" style="display:none">ì—°ê²°í•´ì œ</button>
  </div>

  <div class="chat-input" id="message-input-area" style="display:none">
    <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="500">
    <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
  let stompClient = null;
  let username = null;
  let connected = false;

  function connect() {
    username = document.getElementById('username-input').value.trim();
    if (!username) {
      alert('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    updateConnectionStatus('connecting');

    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    // ë””ë²„ê·¸ ë¡œê¹… ë¹„í™œì„±í™”
    stompClient.debug = null;

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      connected = true;

      updateConnectionStatus('connected');
      showMessageInput();

      // ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
      stompClient.subscribe('/topic/public', function(message) {
        try {
          const chatMessage = JSON.parse(message.body);
          console.log('Received message:', chatMessage);
          displayMessage(chatMessage);
        } catch (e) {
          console.error('Error parsing message:', e);
        }
      });

      // ì‚¬ìš©ì ìƒíƒœ êµ¬ë…
      stompClient.subscribe('/topic/user-status', function(message) {
        try {
          const statusUpdate = JSON.parse(message.body);
          console.log('Status update:', statusUpdate);
          updateOnlineUsers(statusUpdate);
        } catch (e) {
          console.error('Error parsing status update:', e);
        }
      });

      // ì‚¬ìš©ì ì¶”ê°€ ë©”ì‹œì§€ ì „ì†¡
      const joinMessage = {
        sender: username,
        content: username + 'ë‹˜ì´ ì±„íŒ…ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.',
        type: 'JOIN'
      };

      stompClient.send("/app/chat.addUser", {}, JSON.stringify(joinMessage));

    }, function(error) {
      console.error('Connection error:', error);
      updateConnectionStatus('disconnected');
      alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
    });
  }

  function disconnect() {
    if (stompClient !== null && connected) {
      stompClient.disconnect(function() {
        console.log("Disconnected");
      });
    }

    connected = false;
    stompClient = null;
    updateConnectionStatus('disconnected');
    hideMessageInput();
  }

  function sendMessage() {
    const messageContent = document.getElementById('message-input').value.trim();
    if (messageContent && stompClient && connected) {
      const chatMessage = {
        sender: username,
        content: messageContent,
        type: 'CHAT'
      };

      console.log('Sending message:', chatMessage);
      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
      document.getElementById('message-input').value = '';
    }
  }

  function displayMessage(message) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    const now = new Date();
    const timeString = now.toLocaleTimeString();

    if (message.type === 'JOIN' || message.type === 'LEAVE') {
      messageElement.classList.add('system');
      messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${timeString}</div>
                `;
    } else {
      if (message.sender === username) {
        messageElement.classList.add('own');
      } else {
        messageElement.classList.add('other');
      }

      messageElement.innerHTML = `
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${timeString}</div>
                `;
    }

    messagesDiv.appendChild(messageElement);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function updateConnectionStatus(status) {
    const statusDiv = document.getElementById('connection-status');
    statusDiv.className = 'connection-status ' + status;

    switch(status) {
      case 'connected':
        statusDiv.textContent = 'âœ… ì—°ê²°ë¨';
        break;
      case 'connecting':
        statusDiv.textContent = 'ğŸ”„ ì—°ê²° ì¤‘...';
        break;
      default:
        statusDiv.textContent = 'âŒ ì—°ê²° ì•ˆë¨';
    }
  }

  function showMessageInput() {
    document.getElementById('message-input-area').style.display = 'flex';
    document.getElementById('connect-btn').style.display = 'none';
    document.getElementById('disconnect-btn').style.display = 'inline-block';
    document.getElementById('username-input').disabled = true;
    document.getElementById('message-input').focus();
  }

  function hideMessageInput() {
    document.getElementById('message-input-area').style.display = 'none';
    document.getElementById('connect-btn').style.display = 'inline-block';
    document.getElementById('disconnect-btn').style.display = 'none';
    document.getElementById('username-input').disabled = false;
    document.getElementById('username-input').focus();
  }

  function updateOnlineUsers(statusUpdate) {
    if (statusUpdate.totalOnlineUsers !== undefined) {
      document.getElementById('online-count').textContent = statusUpdate.totalOnlineUsers;
    }

    if (statusUpdate.onlineUsers && statusUpdate.onlineUsers.length > 0) {
      const usersList = document.getElementById('online-users-list');
      usersList.textContent = Array.from(statusUpdate.onlineUsers).join(', ');
    } else {
      // APIì—ì„œ ì˜¨ë¼ì¸ ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      fetchOnlineUsers();
    }
  }

  function fetchOnlineUsers() {
    fetch('/api/online-users')
            .then(response => response.json())
            .then(users => {
              const usersList = document.getElementById('online-users-list');
              const usersArray = Array.from(users);
              usersList.textContent = usersArray.length > 0 ? usersArray.join(', ') : 'ì—†ìŒ';

              const count = document.getElementById('online-count');
              count.textContent = usersArray.length;
            })
            .catch(error => {
              console.error('Error fetching online users:', error);
            });
  }

  // Enter í‚¤ ì´ë²¤íŠ¸
  document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  document.getElementById('username-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      connect();
    }
  });

  // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
  window.addEventListener('beforeunload', function() {
    if (connected) {
      disconnect();
    }
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  window.addEventListener('load', function() {
    fetchOnlineUsers();
    document.getElementById('username-input').focus();
  });
</script>
</body>
</html>